import json
import os
import urllib.request
import urllib.error
from http.server import BaseHTTPRequestHandler

CATEGORY_LABELS = {
    "prompt": "AIプロンプト集",
    "notion": "Notionテンプレート",
    "canva": "Canvaテンプレート",
    "ebook": "電子書籍",
    "excel": "Excelテンプレート",
    "spreadsheet": "スプレッドシート",
    "powerpoint": "PowerPointテンプレート",
    "figma": "Figmaテンプレート",
    "checklist": "チェックリスト/ワークシート",
    "linestamp": "LINEスタンプ",
    "icon": "アイコンセット",
    "course": "オンラインコース",
}

# カテゴリ別のコンテンツ生成プロンプト（高品質版）
CONTENT_PROMPTS = {
    "prompt": """あなたは年収1000万円以上を稼ぐトップクラスのAIプロンプトエンジニアです。
以下の商品情報に基づいて、購入者が「これは買ってよかった」と思える最高品質のプロンプト集を作成してください。

【商品名】{product_name}
【ターゲット】{target}
{additional_notes}

【絶対に守るルール】
・#や*などのマークダウン記号は一切使用禁止
・見出しは「■」「◆」「◇」を使用
・箇条書きは「・」を使用
・区切り線は「━━━━━━━━━━」を使用
・番号は「1.」「2.」など普通の数字を使用

【必須の品質基準】
・各プロンプトは実際にChatGPTやClaudeにコピペしてすぐ使える完成形であること
・抽象的な説明ではなく、具体的な指示文を書くこと
・「〇〇を入力」のような穴埋め箇所は [ ] で明示すること
・各プロンプトに期待される出力例を1つ添えること

【構成】
■ はじめに（このプロンプト集の使い方と効果）

■ 第1章：[テーマに合った章タイトル]
プロンプト1〜10（各プロンプトに使い方と出力例を添える）

■ 第2章：[テーマに合った章タイトル]
プロンプト11〜20

■ 第3章：[テーマに合った章タイトル]
プロンプト21〜30

■ 第4章：[テーマに合った章タイトル]
プロンプト31〜40

■ 第5章：[テーマに合った章タイトル]
プロンプト41〜50

■ ボーナス：上級者向けプロンプトテクニック

■ おわりに

合計50個以上のプロンプトを含む、8000文字以上の充実した内容を出力してください。""",

    "ebook": """あなたは累計100万部以上を売り上げたベストセラー作家です。
以下の商品情報に基づいて、読者の人生を変えるほど価値のある電子書籍を執筆してください。

【商品名】{product_name}
【ターゲット】{target}
{additional_notes}

【絶対に守るルール】
・#や*などのマークダウン記号は一切使用禁止
・見出しは「■」「◆」「◇」を使用
・箇条書きは「・」を使用
・区切り線は「━━━━━━━━━━」を使用

【必須の品質基準】
・読者が「これは有料の価値がある」と感じる深い内容
・具体的な事例、数字、エピソードを豊富に含める
・各章の最後に「今すぐできるアクション」を3つ以上記載
・専門用語は使わず、中学生でも理解できる言葉で書く

【構成】
■ はじめに
・この本を手に取ったあなたへ
・この本で得られる3つのこと
・読み方のコツ

■ 第1章：[導入・問題提起]
（2000文字以上、具体的なエピソードから始める）

■ 第2章：[基礎知識・マインドセット]
（2000文字以上、なぜそれが重要なのかを徹底解説）

■ 第3章：[実践方法ステップ1]
（2000文字以上、具体的な手順を詳細に）

■ 第4章：[実践方法ステップ2]
（2000文字以上、よくある失敗と対処法も含める）

■ 第5章：[応用・発展]
（2000文字以上、上級者向けのテクニック）

■ 第6章：[成功事例・ケーススタディ]
（2000文字以上、3つ以上の具体的な成功例）

■ おわりに
・まとめ
・読者へのメッセージ
・次のステップ

合計12000文字以上の充実した内容を出力してください。""",

    "checklist": """あなたは世界的に有名な生産性コンサルタントです。
以下の商品情報に基づいて、使うだけで確実に成果が出るチェックリストを作成してください。

【商品名】{product_name}
【ターゲット】{target}
{additional_notes}

【絶対に守るルール】
・#や*などのマークダウン記号は一切使用禁止
・見出しは「■」「◆」「◇」を使用
・チェック項目は「□」を使用
・区切り線は「━━━━━━━━━━」を使用

【必須の品質基準】
・各チェック項目は具体的で、すぐに行動できる内容
・「〇〇する」という動詞で終わる明確なアクション
・チェックする順番に意味があること（論理的な流れ）
・各セクションに「なぜこれが重要か」の説明を添える

【構成】
■ このチェックリストについて
・対象者
・使い方
・期待できる効果

■ 事前準備チェックリスト（10項目）
□ 具体的なアクション1
□ 具体的なアクション2
...

■ メインチェックリスト：[フェーズ1の名前]（15項目）
◇ このフェーズの目的
□ 具体的なアクション
...

■ メインチェックリスト：[フェーズ2の名前]（15項目）

■ メインチェックリスト：[フェーズ3の名前]（15項目）

■ 仕上げチェックリスト（10項目）

■ トラブルシューティング
・よくある問題と解決策を5つ以上

■ 振り返りシート
・成果を記録する欄
・改善点を書く欄
・次回への申し送り欄

合計60項目以上、6000文字以上の充実した内容を出力してください。""",

    "course": """あなたは受講生の人生を変えてきた伝説的なオンライン講師です。
受講料10万円でも「安い」と言われるレベルの、圧倒的に価値のあるオンラインコース教材を作成してください。

【商品名】{product_name}
【ターゲット】{target}
{additional_notes}

【絶対に守るルール】
・#や*などのマークダウン記号は一切使用禁止
・見出しは「■」「◆」「◇」を使用
・箇条書きは「・」を使用
・区切り線は「━━━━━━━━━━」を使用

【必須の品質基準】
・受講生が確実にスキルを身につけられる段階的なカリキュラム
・各レッスンに具体的なワーク・演習を含める
・実際の事例やケーススタディを豊富に盛り込む
・つまずきやすいポイントと解決策を先回りして説明

【構成】

■ コース概要
・このコースで得られる成果（具体的に3つ以上）
・対象者と前提知識
・学習の進め方
・修了までの目安時間

■ モジュール1：[基礎・導入]
◆ レッスン1-1：[タイトル]
・学習目標
・講義内容（1500文字以上の詳細な解説）
・重要ポイントまとめ
・実践ワーク

◆ レッスン1-2：[タイトル]
（同様の構成）

◆ レッスン1-3：[タイトル]

◆ モジュール1確認テスト（5問）

■ モジュール2：[実践・基本スキル]
◆ レッスン2-1〜2-3
◆ モジュール2確認テスト

■ モジュール3：[実践・応用スキル]
◆ レッスン3-1〜3-3
◆ モジュール3確認テスト

■ モジュール4：[発展・プロレベル]
◆ レッスン4-1〜4-3
◆ モジュール4確認テスト

■ モジュール5：[総合演習・実践プロジェクト]
・課題の説明
・ステップバイステップのガイド
・評価基準
・模範解答例

■ ボーナスコンテンツ
・よくある質問と回答（10個以上）
・追加リソース・参考資料
・修了後の次のステップ

■ 修了証について

合計15レッスン以上、15000文字以上の充実した内容を出力してください。""",

    "notion": """あなたはNotionを使った業務改善で数々の企業を成功に導いたコンサルタントです。
購入者の生産性を劇的に向上させるNotionテンプレートのガイドを作成してください。

【商品名】{product_name}
【ターゲット】{target}
{additional_notes}

【絶対に守るルール】
・#や*などのマークダウン記号は一切使用禁止
・見出しは「■」「◆」「◇」を使用
・箇条書きは「・」を使用
・区切り線は「━━━━━━━━━━」を使用

【必須の品質基準】
・実際にNotionで再現できる具体的な設定手順
・データベースのプロパティは型まで明記
・ビューの設定方法を詳細に説明
・活用シーンごとの使い方を具体的に

【構成】
■ テンプレート概要
・解決できる課題
・得られる効果
・必要な前提知識

■ テンプレート構成図
・全体の構造を図解的に説明

■ データベース1：[名前]
◆ 目的と役割
◆ プロパティ一覧
・プロパティ名 / 型 / 用途 / 設定値
（10個以上のプロパティを詳細に）
◆ ビュー設定
・ビュー名 / 種類 / フィルター / ソート
（5つ以上のビューを詳細に）

■ データベース2：[名前]
（同様の構成）

■ データベース3：[名前]
（同様の構成）

■ ページ構成
・トップページの構成と役割
・各サブページの説明

■ リレーションとロールアップの設定
・どのDBをどう連携させるか
・自動計算の設定方法

■ 使い方ガイド
◆ 初期設定（ステップバイステップ）
◆ 日常的な使い方
◆ 週次レビューの方法
◆ 月次振り返りの方法

■ カスタマイズ例
・ケース1：〇〇な人向けのカスタマイズ
・ケース2：△△な人向けのカスタマイズ
・ケース3：□□な人向けのカスタマイズ

■ よくある質問（10個以上）

■ トラブルシューティング

合計8000文字以上の充実した内容を出力してください。""",

    "excel": """あなたはExcelで業務効率化を実現してきたスペシャリストです。
購入者の作業時間を半分以下にするExcelテンプレートのガイドを作成してください。

【商品名】{product_name}
【ターゲット】{target}
{additional_notes}

【絶対に守るルール】
・#や*などのマークダウン記号は一切使用禁止
・見出しは「■」「◆」「◇」を使用
・箇条書きは「・」を使用
・区切り線は「━━━━━━━━━━」を使用

【必須の品質基準】
・実際の関数やセル参照を具体的に記載
・入力規則やデータ検証の設定方法を詳細に
・条件付き書式の設定を具体的に
・ピボットテーブルやグラフの作成手順も含める

【構成】
■ テンプレート概要
・このテンプレートで実現できること
・想定される時間削減効果
・対応Excelバージョン

■ シート構成
・シート一覧と各シートの役割
・シート間の連携図

■ シート1：[名前]
◆ 目的
◆ セル構成（A1から順に詳細説明）
◆ 使用している関数一覧
・セル番地 / 関数 / 目的 / 具体的な数式
◆ 入力規則の設定
◆ 条件付き書式の設定

■ シート2：[名前]
（同様の構成）

■ シート3：[名前]
（同様の構成）

■ 主要な関数の解説
・VLOOKUP/XLOOKUPの使い方
・IF関数のネスト
・SUMIFS/COUNTIFSの活用
・その他使用している関数

■ 使い方ガイド
◆ 初期設定
◆ データ入力の手順
◆ レポート出力の手順
◆ 月次更新の手順

■ カスタマイズ方法
・項目の追加方法
・計算式の変更方法
・デザインの変更方法

■ よくある質問（10個以上）

■ エラー対処法

合計8000文字以上の充実した内容を出力してください。""",

    "spreadsheet": """あなたはGoogleスプレッドシートの達人として知られるコンサルタントです。
チームの生産性を飛躍的に向上させるスプレッドシートテンプレートのガイドを作成してください。

【商品名】{product_name}
【ターゲット】{target}
{additional_notes}

【絶対に守るルール】
・#や*などのマークダウン記号は一切使用禁止
・見出しは「■」「◆」「◇」を使用
・箇条書きは「・」を使用
・区切り線は「━━━━━━━━━━」を使用

【必須の品質基準】
・Google スプレッドシート特有の関数も活用
・共有設定や権限管理の説明を含める
・Apps Scriptの活用法があれば記載
・リアルタイム共同編集を活かした使い方

【構成】
■ テンプレート概要
・解決できる課題
・チームでの活用メリット
・必要なGoogleアカウント設定

■ シート構成と全体像

■ シート1：[名前]
◆ 目的と役割
◆ セル構成詳細
◆ 使用関数一覧（具体的な数式付き）
◆ データ入力規則
◆ 条件付き書式

■ シート2：[名前]
（同様の構成）

■ シート3：[名前]

■ Googleスプレッドシート特有の機能活用
・IMPORTRANGE関数の設定
・QUERY関数の活用
・GOOGLEFINANCE関数（該当する場合）
・カスタム関数

■ 共有設定ガイド
・閲覧者/編集者の権限設定
・特定セルの保護設定
・共有リンクの発行方法

■ 使い方ガイド
◆ 初期設定
◆ 日常的な使い方
◆ チームでの運用方法

■ カスタマイズ方法

■ よくある質問（10個以上）

合計8000文字以上の充実した内容を出力してください。""",

    "powerpoint": """あなたは大企業の役員プレゼンを数多く手がけてきたプレゼンテーションデザイナーです。
聴衆の心を動かすPowerPointテンプレートのガイドを作成してください。

【商品名】{product_name}
【ターゲット】{target}
{additional_notes}

【絶対に守るルール】
・#や*などのマークダウン記号は一切使用禁止
・見出しは「■」「◆」「◇」を使用
・箇条書きは「・」を使用
・区切り線は「━━━━━━━━━━」を使用

【必須の品質基準】
・各スライドの具体的なレイアウト指示
・フォント、色、サイズの具体的な指定
・アニメーション設定の推奨
・プレゼン時の話し方のコツも含める

【構成】
■ テンプレート概要
・このテンプレートの特徴
・想定する発表シーン
・所要時間の目安

■ デザインコンセプト
・カラーパレット（RGB値を明記）
・フォント指定
・余白とレイアウトの原則

■ スライド構成（全20枚以上）

◆ スライド1：タイトルスライド
・レイアウト詳細
・記載内容
・デザインのポイント

◆ スライド2：アジェンダ
（同様の詳細）

◆ スライド3-5：導入・問題提起

◆ スライド6-10：本論1

◆ スライド11-15：本論2

◆ スライド16-18：解決策・提案

◆ スライド19：まとめ

◆ スライド20：クロージング・CTA

■ 各スライドの原稿テキスト
・スライドごとの話す内容（1分あたり300文字目安）

■ プレゼンテーションのコツ
・話し方のポイント
・質疑応答の準備
・時間配分の目安

■ カスタマイズガイド
・内容の差し替え方法
・デザイン変更のポイント

■ よくある質問

合計8000文字以上の充実した内容を出力してください。""",

    "canva": """あなたはCanvaを使ったデザインで多くのクライアントを成功に導いてきたデザイナーです。
デザイン初心者でもプロ級の成果物が作れるCanvaテンプレートガイドを作成してください。

【商品名】{product_name}
【ターゲット】{target}
{additional_notes}

【絶対に守るルール】
・#や*などのマークダウン記号は一切使用禁止
・見出しは「■」「◆」「◇」を使用
・箇条書きは「・」を使用
・区切り線は「━━━━━━━━━━」を使用

【必須の品質基準】
・Canvaの具体的な操作手順を詳細に
・デザインの原則（配色、フォント、余白）を解説
・各テンプレートの活用シーンを具体的に
・SNSごとの最適サイズも記載

【構成】
■ テンプレートセット概要
・含まれるデザイン一覧
・活用できるシーン
・デザインの統一コンセプト

■ デザインシステム
◆ カラーパレット
・メインカラー（HEX値）
・サブカラー（HEX値）
・アクセントカラー（HEX値）
・使い分けのルール

◆ フォント設定
・見出し用フォント
・本文用フォント
・サイズの目安

◆ デザイン原則
・余白の取り方
・要素の配置ルール
・統一感を出すコツ

■ テンプレート1：[名前]
◆ サイズと用途
◆ デザイン解説
◆ カスタマイズ手順（ステップバイステップ）
◆ 使用例3パターン

■ テンプレート2：[名前]
（同様の構成）

■ テンプレート3-10：
（各テンプレートの詳細）

■ Canva操作ガイド
・基本操作のおさらい
・便利なショートカット
・知っておくと便利な機能

■ 活用アイデア集
・SNS投稿での活用
・印刷物での活用
・プレゼンでの活用

■ よくある質問（10個以上）

合計8000文字以上の充実した内容を出力してください。""",

    "figma": """あなたはFigmaを使ったUIデザインで業界をリードしてきたシニアデザイナーです。
実務で即活用できるFigmaテンプレートのガイドを作成してください。

【商品名】{product_name}
【ターゲット】{target}
{additional_notes}

【絶対に守るルール】
・#や*などのマークダウン記号は一切使用禁止
・見出しは「■」「◆」「◇」を使用
・箇条書きは「・」を使用
・区切り線は「━━━━━━━━━━」を使用

【必須の品質基準】
・コンポーネント設計の詳細
・Auto Layoutの設定を具体的に
・バリアント機能の活用法
・デザインシステムとしての拡張性

【構成】
■ テンプレート概要
・このテンプレートの特徴
・想定ユースケース
・ファイル構成

■ デザイントークン
◆ カラー
・Primary（HEX値）
・Secondary
・Semantic colors（Success, Error, Warning）
・Neutral（グレースケール）

◆ タイポグラフィ
・フォントファミリー
・Font scale（H1-H6, Body, Caption）
・Line height設定

◆ スペーシング
・基準値（4px or 8px）
・スペーシングスケール

◆ エフェクト
・Shadow設定
・Blur設定

■ コンポーネント一覧

◆ Atoms（基本要素）
・Button（全バリアント解説）
・Input
・Icon
・Badge
...

◆ Molecules（組み合わせ）
・Form Field
・Card
・List Item
...

◆ Organisms（複合要素）
・Header
・Navigation
・Footer
...

■ 各コンポーネントの詳細
・プロパティ一覧
・Auto Layout設定
・バリアントの使い分け
・実装時の注意点

■ ページテンプレート
・各ページの構成と使い方

■ 使い方ガイド
・複製とセットアップ
・カスタマイズ方法
・チームでの運用

■ よくある質問

合計8000文字以上の充実した内容を出力してください。""",

    "linestamp": """あなたはLINEスタンプで月収100万円以上を稼いでいるトップクリエイターです。
売れるLINEスタンプの企画書を作成してください。

【商品名】{product_name}
【ターゲット】{target}
{additional_notes}

【絶対に守るルール】
・#や*などのマークダウン記号は一切使用禁止
・見出しは「■」「◆」「◇」を使用
・箇条書きは「・」を使用
・区切り線は「━━━━━━━━━━」を使用

【必須の品質基準】
・市場で売れるキャラクター設定
・実際に使われるシーンを想定したセリフ
・40個全てのスタンプを具体的に
・イラストの構図指示も含める

【構成】
■ コンセプト
・このスタンプセットのテーマ
・ターゲット層
・競合との差別化ポイント
・想定される利用シーン

■ キャラクター設定
◆ 基本情報
・名前
・年齢/性別
・性格（3つの特徴）
・口癖

◆ 外見の詳細
・頭身（2〜3頭身推奨）
・顔の特徴
・体の特徴
・服装
・カラーリング

◆ 表情パターン
・基本表情5種類の詳細

■ スタンプ一覧（40個）

◆ 挨拶系（1-8）
1. おはよう
・セリフ：「おはよ〜」
・表情：にっこり笑顔
・ポーズ：手を振る
・背景：朝日マーク
（以下同様に40個全て詳細に）

◆ 返事系（9-16）

◆ 感情表現系（17-24）

◆ 日常会話系（25-32）

◆ 特殊シーン系（33-40）

■ デザインガイドライン
・キャンバスサイズ（370×320px推奨）
・線の太さ
・色数の目安
・余白の取り方

■ 制作時の注意点
・審査に通るためのポイント
・避けるべき表現
・ファイル形式と書き出し設定

■ 販売戦略
・価格設定
・タイトルとキーワード
・プロモーション方法

合計8000文字以上の充実した内容を出力してください。""",

    "icon": """あなたは大手IT企業のデザインシステムを手がけてきたアイコンデザインの専門家です。
実務で使える高品質なアイコンセットの仕様書を作成してください。

【商品名】{product_name}
【ターゲット】{target}
{additional_notes}

【絶対に守るルール】
・#や*などのマークダウン記号は一切使用禁止
・見出しは「■」「◆」「◇」を使用
・箇条書きは「・」を使用
・区切り線は「━━━━━━━━━━」を使用

【必須の品質基準】
・一貫性のあるデザインルール
・視認性を考慮したサイズ展開
・用途ごとの使い分けガイド
・カスタマイズの余地

【構成】
■ アイコンセット概要
・コンセプト
・スタイル（Line/Solid/Duo-tone等）
・総数
・対応フォーマット

■ デザイン仕様
◆ グリッドシステム
・基準サイズ（24x24px等）
・キーライン（円、正方形、横長、縦長）
・セーフエリア

◆ ストローク設定
・線の太さ
・角の処理（Round/Square）
・端の処理

◆ カラー
・単色版の推奨色
・多色版のカラーパレット

■ カテゴリ別アイコン一覧（50個以上）

◆ ナビゲーション（10個）
・home：ホーム画面への遷移
・search：検索機能
・menu：メニュー表示
（各アイコンの名前、用途、デザインポイント）

◆ アクション（10個）
・edit
・delete
・share
...

◆ ステータス（10個）

◆ ファイル（10個）

◆ コミュニケーション（10個）

◆ その他（10個以上）

■ サイズバリエーション
・16px版の調整ポイント
・24px版（基準）
・32px版の調整ポイント
・48px版の調整ポイント

■ 使用ガイドライン
・推奨される使い方
・避けるべき使い方
・アクセシビリティ配慮

■ ファイル構成
・フォルダ構造
・命名規則
・書き出し設定

■ よくある質問

合計8000文字以上の充実した内容を出力してください。""",
}


def generate_content_with_claude(category: str, product_name: str, target: str, additional_notes: str = ""):
    api_key = os.environ.get("ANTHROPIC_API_KEY")
    if not api_key:
        return {"content": "[ERROR] ANTHROPIC_API_KEY not set. Vercelの環境変数に設定してください。", "filename": "error.txt", "error": "NO_API_KEY"}

    base_prompt = CONTENT_PROMPTS.get(category, CONTENT_PROMPTS["prompt"])

    additional_text = f"【追加要望】{additional_notes}" if additional_notes else ""
    prompt = base_prompt.format(
        product_name=product_name,
        target=target,
        additional_notes=additional_text
    )

    url = "https://api.anthropic.com/v1/messages"

    payload = {
        "model": "claude-3-5-sonnet-20241022",
        "max_tokens": 16384,
        "messages": [{"role": "user", "content": prompt}]
    }

    try:
        req = urllib.request.Request(
            url,
            data=json.dumps(payload).encode("utf-8"),
            headers={
                "Content-Type": "application/json",
                "x-api-key": api_key,
                "anthropic-version": "2023-06-01"
            },
            method="POST",
        )
        with urllib.request.urlopen(req, timeout=120) as response:
            result = json.loads(response.read().decode("utf-8"))
            content = result["content"][0]["text"]

            safe_name = product_name.replace(" ", "_").replace("/", "_")[:50]
            filename = f"{safe_name}.txt"

            return {"content": content, "filename": filename}
    except urllib.error.HTTPError as e:
        error_body = e.read().decode("utf-8")
        return {"content": f"[ERROR] Claude API HTTP {e.code}: {error_body}", "filename": "error.txt", "error": error_body}
    except Exception as e:
        error_msg = str(e)
        return {"content": f"[ERROR] Claude API failed: {error_msg}", "filename": "error.txt", "error": error_msg}


def generate_mock_content(category: str, product_name: str, target: str):
    category_label = CATEGORY_LABELS.get(category, "デジタル商品")

    mock_content = f"""◆ {product_name}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ はじめに

この{category_label}は「{target}」の方に向けて作成しました。

本コンテンツでは、あなたが求める成果を確実に手に入れるための
具体的なノウハウを惜しみなくお伝えしていきます。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ このコンテンツで得られること

・具体的なスキルと知識
・すぐに実践できるテクニック
・よくある失敗を避ける方法
・成功への最短ルート

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ 第1章：基礎を固める

ここでは、成功のために必要な基礎知識を学びます。

◇ ポイント1：なぜこれが重要なのか
多くの人が見落としがちですが、基礎を固めることで
その後の成長スピードが大きく変わります。

◇ ポイント2：具体的な手順
・ステップ1：まず〇〇を確認する
・ステップ2：次に△△を設定する
・ステップ3：□□を実行する

◇ 今すぐできるアクション
1. 現状を紙に書き出す
2. 目標を明確にする
3. 最初の一歩を決める

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ 第2章：実践テクニック

基礎を理解したら、次は実践です。

◇ テクニック1：〇〇法
具体的な手順を説明します...

◇ テクニック2：△△アプローチ
別の効果的な方法を紹介します...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ 第3章：よくある質問と回答

Q: 〇〇はどうすればいいですか？
A: 〇〇の場合は、以下の手順で対応できます。
   1. まず確認する
   2. 次に調整する
   3. 最後に実行する

Q: △△の場合はどうなりますか？
A: △△の場合は、□□を試してください。
   多くの場合、これで解決します。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

■ おわりに

ここまでお読みいただき、ありがとうございました。

このコンテンツの内容を実践すれば、必ず成果が出ます。
大切なのは、学んだことをすぐに行動に移すことです。

あなたの成功を心より応援しています。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

ご購入ありがとうございました。
"""

    safe_name = product_name.replace(" ", "_").replace("/", "_")[:50]
    filename = f"{safe_name}.txt"

    return {"content": mock_content, "filename": filename}


class handler(BaseHTTPRequestHandler):
    def do_OPTIONS(self):
        self.send_response(200)
        self.send_header("Access-Control-Allow-Origin", "*")
        self.send_header("Access-Control-Allow-Methods", "GET, POST, OPTIONS")
        self.send_header("Access-Control-Allow-Headers", "Content-Type")
        self.end_headers()

    def do_POST(self):
        content_length = int(self.headers.get("Content-Length", 0))
        body = self.rfile.read(content_length)

        try:
            data = json.loads(body)
            category = data.get("category", "prompt")
            product_name = data.get("productName", "")
            target = data.get("target", "")
            additional_notes = data.get("additionalNotes", "")

            if not product_name:
                raise ValueError("productName is required")

            result = generate_content_with_claude(category, product_name, target, additional_notes)

            self.send_response(200)
            self.send_header("Content-type", "application/json")
            self.send_header("Access-Control-Allow-Origin", "*")
            self.end_headers()
            self.wfile.write(json.dumps(result).encode())
        except Exception as e:
            self.send_response(400)
            self.send_header("Content-type", "application/json")
            self.send_header("Access-Control-Allow-Origin", "*")
            self.end_headers()
            self.wfile.write(json.dumps({"error": str(e)}).encode())
